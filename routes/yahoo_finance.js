var querystring = require("querystring");
var SectorList = require('../models/sector_list')
var Company = require('../models/company');
var CompanyList = require('../models/company_list');
var utility = require("./utility");
var http = require('http');

exports.getStockDetails = function(sector, res, callBack) {
	var companiesList = new CompanyList();
	
	var sectorCompanies = SectorList.getSector(sector);
	var str = "(";
	for(var i = 0; i < sectorCompanies.length; i++) {
		str += "\"" + sectorCompanies[i].getSymbol() + "\"";
		if(i < sectorCompanies.length - 1) {
			str += ", ";
		}
	}
	str += ")";
	
	var query = 'select * from yahoo.finance.quote where symbol in ' + str;

	var encodedQuery = querystring.stringify({q : query});
	encodedQuery += '&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=';

	// var url = "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quote%20where%20symbol%20in%20(%22VNET%22%2C%20%22TWOU%22%2C%20%22JOBS%22%2C%20%22ACIW%22%2C%20%22ACTS%22%2C%20%22ATVI%22%2C%20%22ACTA%22%2C%20%22ACXM%22%2C%20%22ADEP%22%2C%20%22ADBE%22%2C%20%22AMD%22%2C%20%22ADVS%22%2C%20%22AGYS%22%2C%20%22AMCN%22%2C%20%22AIXG%22%2C%20%22AFOP%22%2C%20%22ALLT%22%2C%20%22MDRX%22%2C%20%22AOSL%22%2C%20%22ALTR%22%2C%20%22AMBA%22%2C%20%22DOX%22%2C%20%22AMSWA%22%2C%20%22AMKR%22%2C%20%22ASYS%22%2C%20%22ANAD%22%2C%20%22ADI%22%2C%20%22ANSS%22%2C%20%22ATNY%22%2C%20%22AAPL%22%2C%20%22AMAT%22%2C%20%22AMCC%22%2C%20%22AAOI%22%2C%20%22ARIS%22%2C%20%22ARMH%22%2C%20%22ARRS%22%2C%20%22ARUN%22%2C%20%22ASTI%22%2C%20%22ASMI%22%2C%20%22ASML%22%2C%20%22AZPN%22%2C%20%22ALOT%22%2C%20%22ASUR%22%2C%20%22ATML%22%2C%20%22ATTU%22%2C%20%22ADNC%22%2C%20%22ADAT%22%2C%20%22ABTL%22%2C%20%22ADSK%22%2C%20%22ADP%22%2C%20%22AVGO%22%2C%20%22AVNW%22%2C%20%22AWRE%22%2C%20%22ACLS%22%2C%20%22AXTI%22%2C%20%22BOSC%22%2C%20%22BIDU%22%2C%20%22BBSI%22%2C%20%22BV%22%2C%20%22BNFT%22%2C%20%22BBOX%22%2C%20%22BLKB%22%2C%20%22BCOR%22%2C%20%22EPAY%22%2C%20%22BLIN%20%20%20%20%20%20%20%20%20%20%22%2C%20%22BCOV%22%2C%20%22BRCM%22%2C%20%22BSFT%22%2C%20%22BVSN%22%2C%20%22BRCD%22%2C%20%22BRKS%22%2C%20%22CA%22%2C%20%22CCMP%22%2C%20%22CDNS%22%2C%20%22CAMP%22%2C%20%22CALD%22%2C%20%22CSIQ%22%2C%20%22CARB%22%2C%20%22CAVM%22%2C%20%22CBDE%22%2C%20%22CRNT%22%2C%20%22CERN%22%2C%20%22CEVA%22%2C%20%22CYOU%22%2C%20%22CHKP%22%2C%20%22CNIT%22%2C%20%22CMGE%22%2C%20%22CSUN%22%2C%20%22CCIH%22%2C%20%22CNET%22%2C%20%22IMOS%22%2C%20%22CRUS%22%2C%20%22CSCO%22%2C%20%22CTXS%22%2C%20%22CLNT%22%2C%20%22CKSW%22%2C%20%22CCOI%22%2C%20%22CTSH%22%2C%20%22CLRX%22%2C%20%22COMM%22%2C%20%22CVLT%22%2C%20%22CPSI%22%2C%20%22CTG%22%2C%20%22CMTL%22%2C%20%22CCUR%22%2C%20%22CNXR%22%2C%20%22CTCT%22%2C%20%22CSOD%22%2C%20%22CPAH%22%2C%20%22COVS%22%2C%20%22CRAY%22%2C%20%22CREE%22%2C%20%22CRTO%22%2C%20%22CCRN%22%2C%20%22CRDS%22%2C%20%22CSGS%22%2C%20%22CSPI%22%2C%20%22CSRE%22%2C%20%22CVV%22%2C%20%22CYBR%22%2C%20%22CY%22%2C%20%22CYRN%22%2C%20%22DAEG%22%2C%20%22DTLK%22%2C%20%22DRAM%22%2C%20%22DWCH%22%2C%20%22TRAK%22%2C%20%22DGII%22%2C%20%22DMRC%22%2C%20%22DGLY%22%2C%20%22DIOD%22%2C%20%22DLHC%22%2C%20%22HILL%22%2C%20%22DSPG%22%2C%20%22ELNK%22%2C%20%22EBIX%22%2C%20%22ELON%22%2C%20%22SATS%22%2C%20%22EDGW%22%2C%20%22EFUT%22%2C%20%22EGAN%22%2C%20%22ELRC%22%2C%20%22EA%22%2C%20%22EFII%22%2C%20%22ELTK%22%2C%20%22EMKR%22%2C%20%22EIGI%22%2C%20%22WATT%22%2C%20%22ERII%22%2C%20%22ENOC%22%2C%20%22ENPH%22%2C%20%22ENTR%22%2C%20%22ENVI%22%2C%20%22EPIQ%22%2C%20%22PLUS%22%2C%20%22ERIC%22%2C%20%22EVOL%22%2C%20%22EXA%22%2C%20%22EXTR%22%2C%20%22EZCH%22%2C%20%22FFIV%22%2C%20%22FB%22%2C%20%22FCS%22%2C%20%22FALC%22%2C%20%22FNSR%22%2C%20%22FEYE%22%2C%20%22FSLR%22%2C%20%22FISV%22%2C%20%22FIVN%22%2C%20%22FLEX%22%2C%20%22FORM%22%2C%20%22FORTY%22%2C%20%22FTNT%22%2C%20%22GIGM%22%2C%20%22GILT%22%2C%20%22GLUU%22%2C%20%22GOOG%22%2C%20%22GOOGL%22%2C%20%22GRPN%22%2C%20%22GSIT%22%2C%20%22GUID%22%2C%20%22HQCL%22%2C%20%22HLIT%22%2C%20%22HSTM%22%2C%20%22HSII%22%2C%20%22HIMX%22%2C%20%22AWAY%22%2C%20%22HDP%22%2C%20%22HSON%22%2C%20%22INVE%22%2C%20%22DSKY%22%2C%20%22IGTE%22%2C%20%22IMMR%22%2C%20%22SAAS%22%2C%20%22INFA%22%2C%20%22INOD%22%2C%20%22ISSC%22%2C%20%22INOV%22%2C%20%22IDTI%22%2C%20%22ISSI%22%2C%20%22INTC%22%2C%20%22ININ%22%2C%20%22IMI%22%2C%20%22INAP%22%2C%20%22IIJI%22%2C%20%22INPH%22%2C%20%22INTX%22%2C%20%22ISIL%22%2C%20%22IVAC%22%2C%20%22INTU%22%2C%20%22IPAS%22%2C%20%22IPGP%22%2C%20%22IXYS%22%2C%20%22JCOM%22%2C%20%22JASO%22%2C%20%22JKHY%22%2C%20%22JDSU%22%2C%20%22DATE%22%2C%20%22JIVE%22%2C%20%22KELYA%22%2C%20%22KELYB%22%2C%20%22KTEC%22%2C%20%22KTCC%22%2C%20%22KFRC%22%2C%20%22KE%22%2C%20%22KONE%22%2C%20%22KFX%22%2C%20%22KZ%22%2C%20%22KOPN%22%2C%20%22KLIC%22%2C%20%22KVHI%22%2C%20%22LRCX%22%2C%20%22LTRX%22%2C%20%22LSCC%22%2C%20%22LTRPA%22%2C%20%22LTRPB%22%2C%20%22LPTH%22%2C%20%22LECO%22%2C%20%22LLTC%22%2C%20%22LIQD%22%2C%20%22LIVE%22%2C%20%22LPSN%22%2C%20%22LOGI%22%2C%20%22LOGM%22%2C%20%22LOOK%22%2C%20%22LORL%22%2C%20%22MTSI%22%2C%20%22MGIC%22%2C%20%22MNGA%22%2C%20%22COOL%22%2C%20%22MAMS%22%2C%20%22MANH%22%2C%20%22MNTX%22%2C%20%22MKTO%22%2C%20%22MRVL%22%2C%20%22MTLS%22%2C%20%22MTSN%22%2C%20%22MXIM%22%2C%20%22MGRC%22%2C%20%22MDCA%22%2C%20%22MDAS%22%2C%20%22MTBC%22%2C%20%22MDSO%22%2C%20%22MLNX%22%2C%20%22MENT%22%2C%20%22MRGE%22%2C%20%22MERU%22%2C%20%22MCRL%22%2C%20%22MCHP%22%2C%20%22MU%22%2C%20%22MSCC%22%2C%20%22MSFT%22%2C%20%22MSTR%22%2C%20%22MNDO%22%2C%20%22MIND%22%2C%20%22MITK%22%2C%20%22MITL%22%2C%20%22MOBL%22%2C%20%22MDSY%22%2C%20%22MOKO%22%2C%20%22MOMO%22%2C%20%22MPWR%22%2C%20%22TYPE%22%2C%20%22MOSY%22%2C%20%22MRVC%22%2C%20%22MFLX%22%2C%20%22NATI%22%2C%20%22NCIT%22%2C%20%22NETE%22%2C%20%22NTAP%22%2C%20%22NLST%22%2C%20%22NTCT%22%2C%20%22NTWK%22%2C%20%22NICE%22%2C%20%22NUAN%22%2C%20%22NVEC%22%2C%20%22NVDA%22%2C%20%22NXPI%22%2C%20%22OIIM%22%2C%20%22OCLR%22%2C%20%22OMCL%22%2C%20%22OVTI%22%2C%20%22ON%22%2C%20%22OTIV%22%2C%20%22OTEX%22%2C%20%22OSIS%22%2C%20%22PFIN%22%2C%20%22PCYG%22%2C%20%22PRKR%22%2C%20%22PCTY%22%2C%20%22PCTI%22%2C%20%22PDFS%22%2C%20%22PEGA%22%2C%20%22PRFT%22%2C%20%22PSEM%22%2C%20%22PERI%22%2C%20%22PLAB%22%2C%20%22PXLW%22%2C%20%22PLXS%22%2C%20%22PMCS%22%2C%20%22PNTR%22%2C%20%22POWI%22%2C%20%22PKT%22%2C%20%22IPDN%22%2C%20%22PRGS%22%2C%20%22PFPT%22%2C%20%22PTC%22%2C%20%22QADA%22%2C%20%22QADB%22%2C%20%22QLIK%22%2C%20%22QLGC%22%2C%20%22QRVO%22%2C%20%22QCOM%22%2C%20%22QSII%22%2C%20%22QBAK%22%2C%20%22QLYS%22%2C%20%22QRHC%22%2C%20%22QUIK%22%2C%20%22QUMU%22%2C%20%22RDCM%22%2C%20%22RSYS%22%2C%20%22RMBS%22%2C%20%22RCMT%22%2C%20%22RLOC%22%2C%20%22RNWK%22%2C%20%22RP%22%2C%20%22RCII%22%2C%20%22RESN%22%2C%20%22RVBD%22%2C%20%22FUEL%22%2C%20%22RBCN%22%2C%20%22SABR%22%2C%20%22SNDK%22%2C%20%22SANM%22%2C%20%22SPNS%22%2C%20%22SCSC%22%2C%20%22SGMS%22%2C%20%22SQI%22%2C%20%22SEAC%22%2C%20%22STX%22%2C%20%22SLTC%22%2C%20%22LEDS%22%2C%20%22SMTC%22%2C%20%22SGOC%22%2C%20%22SWIR%22%2C%20%22SIFY%22%2C%20%22SIGM%22%2C%20%22SGMA%22%2C%20%22SILC%22%2C%20%22SGI%22%2C%20%22SLAB%22%2C%20%22SIMO%22%2C%20%22SPIL%22%2C%20%22SLP%22%2C%20%22SINA%22%2C%20%22MOBI%22%2C%20%22SWKS%22%2C%20%22SMT%22%2C%20%22SMSI%22%2C%20%22SMTX%22%2C%20%22SMTP%22%2C%20%22SOHU%22%2C%20%22SEDG%22%2C%20%22SOFO%22%2C%20%22SONS%22%2C%20%22SPDC%22%2C%20%22ANY%22%2C%20%22SPLK%22%2C%20%22SPSC%22%2C%20%22SSNC%22%2C%20%22SSYS%22%2C%20%22STRM%22%2C%20%22SEMI%22%2C%20%22GOMO%22%2C%20%22SPWR%22%2C%20%22SMCI%22%2C%20%22SPCB%22%2C%20%22SCON%22%2C%20%22SPRT%22%2C%20%22SYKE%22%2C%20%22SYMC%22%2C%20%22SYNC%22%2C%20%22SYNA%22%2C%20%22SNCR%22%2C%20%22SNPS%22%2C%20%22SYNT%22%2C%20%22SYRX%22%2C%20%22TTWO%22%2C%20%22TNGO%22%2C%20%22TECD%22%2C%20%22TCCO%22%2C%20%22TSYS%22%2C%20%22TTEC%22%2C%20%22TSRA%22%2C%20%22TXN%22%2C%20%22DSGX%22%2C%20%22KEYW%22%2C%20%22MIDD%22%2C%20%22ULTI%22%2C%20%22TIGR%22%2C%20%22TISA%22%2C%20%22TSEM%22%2C%20%22TACT%22%2C%20%22TZOO%22%2C%20%22TRIP%22%2C%20%22TRUE%22%2C%20%22TSRI%22%2C%20%22TTMI%22%2C%20%22TUBE%22%2C%20%22TCX%22%2C%20%22TWIN%22%2C%20%22UBIC%22%2C%20%22UBNT%22%2C%20%22UCTT%22%2C%20%22UTEK%22%2C%20%22UNTD%22%2C%20%22UPIP%22%2C%20%22UPLD%22%2C%20%22VRNS%22%2C%20%22VDSI%22%2C%20%22VECO%22%2C%20%22VRNT%22%2C%20%22VRSN%22%2C%20%22VRSK%22%2C%20%22VSAT%22%2C%20%22VIAS%22%2C%20%22VGGL%22%2C%20%22VIMC%22%2C%20%22VRTU%22%2C%20%22VISN%22%2C%20%22VTSS%22%2C%20%22VUZI%22%2C%20%22WAVX%22%2C%20%22WSTG%22%2C%20%22WWWW%22%2C%20%22WB%22%2C%20%22WDC%22%2C%20%22WIX%22%2C%20%22WPPGY%22%2C%20%22WSCI%22%2C%20%22XLNX%22%2C%20%22XPLR%22%2C%20%22XNET%22%2C%20%22YHOO%22%2C%20%22YNDX%22%2C%20%22YDLE%22%2C%20%22YY%22%2C%20%22ZBRA%22%2C%20%22ZIXI%22%2C%20%22ZNGA%22)&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback="

	var options = {
		host: 'query.yahooapis.com',
		path: '/v1/public/yql?' + encodedQuery,
		headers: {
			'Content-Type': 'application/x-www-form-urlencoded',
		}
	};

	console.log("------- Fetching stock details for " + sector + " from Yahoo finance API --------");
	var httpGet = http.request(options, function(response) {
		var str = '';
		response.on('data', function (chunk) {
			str += chunk;
		});

		response.on('end', function () {
			console.log("------- Stock details fetched --------");
			try {
				var parsed = JSON.parse(str);
				var quotes = parsed.query.results.quote;
				
				for(var i = 0; i < quotes.length; i++) {
					var company = new Company(quotes[i].symbol, quotes[i].Name, quotes[i].DaysHigh);
					companiesList.addCompany(company);
				}
				callBack(companiesList);
			} catch (ex) {
				console.log(ex);
				var errorMessage = "Error occurred while parsing Yahoo finance API response: " + JSON.stringify(ex);
				utility.sendFailureJSON(res, errorMessage);
			}
		});
	});
	
	httpGet.on('error', function(e) {
		console.log("------- Error occurred while fetching stock details --------");
		utility.sendFailureJSON(res, "Error occurred while fetching stock details " + e.message);
	});

	httpGet.end();
}
